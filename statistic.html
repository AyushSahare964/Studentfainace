<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Statistics - Finance Tracker</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Poppins', Arial, sans-serif;
      margin: 0;
      background-color: #f0f4f8;
      text-align: center;
    }

    .gradient-bg {
      background: linear-gradient(to right, #6EE7B7, #3B82F6);
    }

    h1 {
      color: #2c3e50;
      font-size: 2.5rem;
      margin-bottom: 20px;
      padding-top: 20px;
    }

    h2 {
      color: #34495e;
      margin-top: 40px;
      font-size: 2rem;
    }

    .card-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      margin-bottom: 40px;
      padding: 0 10px;
    }

    .card {
      background: white;
      padding: 20px;
      width: 100%;
      max-width: 320px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      text-align: center;
      box-sizing: border-box;
    }

    .card h3 {
      color: #4f46e5;
      margin-bottom: 10px;
      font-size: 1.5rem;
    }

    .card p, .card ul {
      font-size: 1.2rem;
      font-weight: bold;
      color: #2c3e50;
    }

    .chart-container {
      position: relative;
      width: 95%;
      max-width: 600px;
      margin: 30px auto;
      background: #ffffff;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
      box-sizing: border-box;
    }

    canvas {
      width: 100% !important;
      height: auto !important;
    }

    @media (min-width: 640px) {
      .card-container {
        justify-content: space-around;
      }
      .card {
        width: calc(50% - 20px);
      }
    }

    @media (min-width: 1024px) {
      .card {
        width: calc(33.33% - 20px);
      }
    }

    .misc-item {
      text-align: left;
      font-weight: normal;
      font-size: 0.9rem;
      margin: 5px 0;
      border-bottom: 1px dashed #eee;
      padding-bottom: 5px;
    }
    .misc-item:last-child {
      border-bottom: none;
    }

    .misc-item span {
      font-weight: bold;
      color: #4f46e5;
    }

    /* Profile Dropdown Styles */
    .profile-container {
      position: relative;
    }
    .profile-dropdown {
      position: absolute;
      top: 100%; /* Position below the button */
      right: 0;
      background-color: white;
      border-radius: 0.5rem; /* rounded-lg */
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* shadow-md */
      width: 150px;
      overflow: hidden;
      margin-top: 0.5rem; /* Space between button and dropdown */
      z-index: 50; /* Ensure it's above other content */
      display: none; /* Hidden by default */
    }
    .profile-dropdown a {
      display: block;
      padding: 0.75rem 1rem; /* py-3 px-4 */
      color: #4B5563; /* gray-700 */
      text-decoration: none;
      font-size: 0.9rem;
      transition: background-color 0.2s ease;
    }
    .profile-dropdown a:hover {
      background-color: #F3F4F6; /* gray-100 */
    }
    /* Show dropdown on parent hover/focus (for desktop) */
    .profile-container:hover .profile-dropdown {
      display: block;
    }
    /* For touch devices, consider adding JS to toggle visibility on click */
  </style>
</head>

<body>

<!-- Header -->
<header class="gradient-bg text-white py-5 shadow-md">
  <div class="container mx-auto px-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">üìä Spending Statistics</h1>
    
    <nav class="flex items-center space-x-4">
      <!-- This will be shown when user is NOT logged in -->
      <div id="guest-nav" class="flex space-x-4">
        <a href="log.html" class="text-white hover:underline text-lg">Login</a>
        <a href="register.html" class="text-white hover:underline text-lg">Register</a>
      </div>

      <!-- This will be shown when user is logged in -->
      <div id="user-nav" class="hidden">
        <div class="profile-container relative">
          <button id="profile-button" class="flex items-center space-x-2 focus:outline-none">
            <span id="username-display" class="text-lg">User</span>
            <div class="w-8 h-8 rounded-full bg-white text-indigo-600 flex items-center justify-center font-bold">
              <span id="user-initial">U</span>
            </div>
          </button>
          <div class="profile-dropdown">
            <a href="index.html">üè† Home</a>
            <a href="profile.html">üë§ My Profile</a>
            <a href="setting.html">‚öôÔ∏è Settings</a>
            <a href="#" id="logout-btn">üö™ Logout</a>
          </div>
        </div>
      </div>
    </nav>
  </div>
</header>

<h1 class="mt-8">Self Finance Tracker üí∏</h1>

<!-- Auth Message -->
<div id="authMessage" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-xl mx-auto mb-8" role="alert" style="display: none;">
  <strong class="font-bold">Access Denied:</strong>
  <span class="block sm:inline">Please <a href="log.html" class="font-semibold text-red-800 hover:underline">sign in</a> to view your spending statistics.</span>
</div>

<!-- Main Statistics Content -->
<div id="statisticsContent" style="display: none;">
  <!-- Dashboard Cards -->
  <div class="card-container">

    <!-- üß© Daily Summary -->
    <div class="card">
      <h3>üß© Today's Spend</h3>
      <p id="dailySummaryDisplay">Loading...</p>
      <p id="dailyLimitDisplay">Daily Limit: Loading...</p>
      <p id="dailyRemaining">Remaining: Loading...</p>
    </div>

    <!-- üìÖ Monthly Overview -->
    <div class="card">
      <h3>üìÖ Monthly Overview</h3>
      <p>Total Spent: <span id="monthlyTotal">Loading...</span></p>
      <p>Average Daily: <span id="monthlyAverage">Loading...</span></p>
      <p>Days with Spend: <span id="daysWithSpendCount">Loading...</span></p>
    </div>

    <!-- üßæ Miscellaneous Spend -->
    <div class="card">
      <h3>üßæ Miscellaneous Spend</h3>
      <p>Total: <span id="miscTotal">‚Çπ0</span></p>
      <ul id="miscellaneousSpendList" class="text-left text-gray-700 text-sm mt-3 space-y-2">
        <li>Loading...</li>
      </ul>
    </div>

    <!-- üí∞ Savings Overview -->
    <div class="card">
      <h3>üí∞ Monthly Savings</h3>
      <p>Total Saved: <span id="monthlySavingDisplay">Loading...</span></p>
      <p>Savings Goals: <span id="totalSavingsGoalsDisplay">Loading...</span></p>
    </div>

  </div>

  <h2>Today's Spending Breakdown by Category</h2>

  <!-- Pie Chart -->
  <div class="chart-container">
    <canvas id="expense-chart"></canvas>
  </div>

  <!-- Historical Daily Spends section removed as requested -->

</div>

<!-- JavaScript -->
<script>
  // === IMPORTANT: USE THIS EXACT FIREBASE CONFIGURATION IN ALL YOUR FILES ===
  const firebaseConfig = {
    apiKey: "AIzaSyCGKPCg1tzXvIXs9DMAed5SxWWAng43O-8",
    authDomain: "self-finance-13029.firebaseapp.com",
    projectId: "self-finance-13029",
    storageBucket: "self-finance-13029.firebasestorage.app", // Ensure this matches all files!
    messagingSenderId: "233384300457",
    appId: "1:233384300457:web:e1b17b44c88fdac89f7eb8",
    measurementId: "G-QT3K94SFZ3"
  };
  firebase.initializeApp(firebaseConfig);

  const auth = firebase.auth();
  const db = firebase.firestore();

  let userId = null; // Stores the current authenticated user's ID

  const authMessage = document.getElementById('authMessage');
  const statisticsContent = document.getElementById('statisticsContent');

  // New header elements
  const guestNav = document.getElementById('guest-nav');
  const userNav = document.getElementById('user-nav');
  const usernameDisplay = document.getElementById('username-display');
  const userInitial = document.getElementById('user-initial');
  const logoutBtn = document.getElementById('logout-btn');
  const profileButton = document.getElementById('profile-button'); // Added for dropdown toggle

  // Dashboard card elements
  const dailySummaryDisplay = document.getElementById('dailySummaryDisplay');
  const dailyLimitDisplay = document.getElementById('dailyLimitDisplay');
  const dailyRemaining = document.getElementById('dailyRemaining');
  const monthlyTotal = document.getElementById('monthlyTotal');
  const monthlyAverage = document.getElementById('monthlyAverage');
  const daysWithSpendCount = document.getElementById('daysWithSpendCount');
  const miscTotal = document.getElementById('miscTotal');
  const miscellaneousSpendList = document.getElementById('miscellaneousSpendList');
  const monthlySavingDisplay = document.getElementById('monthlySavingDisplay'); // New
  const totalSavingsGoalsDisplay = document.getElementById('totalSavingsGoalsDisplay'); // New


  let expenseChart = null; // To hold the Chart.js instance

  // --- Authentication State Listener ---
  auth.onAuthStateChanged(user => {
    if (user) {
      userId = user.uid;
      console.log("User signed in:", userId);
      authMessage.style.display = 'none';
      statisticsContent.style.display = 'block';

      // Show user-specific navigation, hide guest navigation
      guestNav.classList.add('hidden');
      userNav.classList.remove('hidden');
      
      // Update username and initial
      const displayName = user.displayName || user.email.split('@')[0];
      usernameDisplay.textContent = displayName;
      userInitial.textContent = displayName.charAt(0).toUpperCase();

      loadSpendingStatistics(); // Load all data for the authenticated user
    } else {
      userId = null;
      console.log("No user signed in. Statistics page functionality disabled.");
      authMessage.style.display = 'block';
      statisticsContent.style.display = 'none';

      // Hide user-specific navigation, show guest navigation
      guestNav.classList.remove('hidden');
      userNav.classList.add('hidden');

      // Clear or reset all displayed data if user logs out
      dailySummaryDisplay.textContent = 'Loading...';
      dailyLimitDisplay.textContent = 'Daily Limit: N/A';
      dailyRemaining.textContent = 'Remaining: N/A';
      monthlyTotal.textContent = 'N/A';
      monthlyAverage.textContent = 'N/A';
      daysWithSpendCount.textContent = 'N/A';
      miscTotal.textContent = '‚Çπ0';
      miscellaneousSpendList.innerHTML = '<li>Please sign in to view miscellaneous spends.</li>';
      monthlySavingDisplay.textContent = 'N/A'; // Clear new savings display
      totalSavingsGoalsDisplay.textContent = 'N/A'; // Clear new savings display


      // Destroy the chart if it exists
      if (expenseChart) {
        expenseChart.destroy();
        expenseChart = null;
      }
    }
  });

  // --- Logout Functionality ---
  logoutBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    try {
      await auth.signOut();
      alert('You have been logged out.');
      // Redirect to login page or home page after logout if needed
      window.location.href = 'log.html'; // Or 'index.html'
    } catch (error) {
      console.error("Error logging out:", error);
      alert("Error logging out: " + error.message);
    }
  });

  // Toggle profile dropdown on click for mobile/touch devices
  // For desktop, CSS :hover handles it.
  if (profileButton) {
    profileButton.addEventListener('click', () => {
      const dropdown = profileButton.nextElementSibling; // Get the .profile-dropdown
      if (dropdown) {
        dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
      }
    });

    // Close dropdown if clicked outside
    document.addEventListener('click', (event) => {
      if (!profileButton.contains(event.target) && !userNav.contains(event.target)) {
        const dropdown = profileButton.nextElementSibling;
        if (dropdown) {
          dropdown.style.display = 'none';
        }
      }
    });
  }


  // --- Main Data Loading Function ---
  async function loadSpendingStatistics() {
    if (!userId) return; // Should not be called without userId due to onAuthStateChanged guard

    try {
      // 1. Fetch Daily Limits and Spends
      const dailyLimitDocRef = db.collection('users').doc(userId).collection('dailyLimits').doc('current');
      const dailyLimitDoc = await dailyLimitDocRef.get();

      let dailyLimit = 0;
      let allSpends = [];
      // let lastSetDate = ''; // Not used in this context

      if (dailyLimitDoc.exists) {
        const data = dailyLimitDoc.data();
        dailyLimit = parseFloat(data.limit || 0);
        allSpends = data.spends || [];
        // lastSetDate = data.lastSetDate || ''; // Not used
      }

      // 2. Fetch Miscellaneous Spends
      const miscSpendsSnapshot = await db.collection('users').doc(userId).collection('miscellaneousSpends').get();
      const miscellaneousSpends = miscSpendsSnapshot.docs.map(doc => doc.data());

      // 3. Fetch Savings Data
      const savingsSnapshot = await db.collection('users').doc(userId).collection('savings').get();
      const savingsData = savingsSnapshot.docs.map(doc => doc.data());


      // --- Process Data for Dashboard Cards & Charts ---

      // Today's Summary
      const today = new Date();
      today.setHours(0,0,0,0); // Normalize to start of day for comparison

      const todaysSpends = allSpends.filter(spend => {
        // Ensure timestamp is a Firestore Timestamp object and convert to Date for comparison
        if (spend.timestamp && typeof spend.timestamp.toDate === 'function') {
          const spendDate = spend.timestamp.toDate();
          spendDate.setHours(0,0,0,0);
          return spendDate.getTime() === today.getTime();
        }
        return false;
      });

      const totalToday = todaysSpends.reduce((sum, item) => sum + item.amount, 0);
      const remainingToday = (dailyLimit - totalToday).toFixed(2);

      dailySummaryDisplay.textContent = `‚Çπ${totalToday.toFixed(2)}`;
      dailyLimitDisplay.textContent = `Daily Limit: ‚Çπ${dailyLimit.toFixed(2)}`;
      dailyRemaining.textContent = `Remaining: ‚Çπ${remainingToday}`;
      dailyRemaining.style.color = remainingToday >= 0 ? '#10B981' : '#EF4444';


      // Monthly Overview (current month and year)
      const currentMonth = today.getMonth();
      const currentYear = today.getFullYear();
      let totalSpentThisMonth = 0;
      let totalSavingsThisMonth = 0; // New variable for monthly savings
      let daysWithSpendSet = new Set(); // To count distinct days with spend

      // Calculate total daily categorized spends for the current month
      allSpends.forEach(spend => {
        if (spend.timestamp && typeof spend.timestamp.toDate === 'function') {
          const spendDate = spend.timestamp.toDate();
          if (spendDate.getMonth() === currentMonth && spendDate.getFullYear() === currentYear) {
            totalSpentThisMonth += spend.amount;
            daysWithSpendSet.add(spendDate.toISOString().split('T')[0]); // Add unique date string
          }
        }
      });

      // Add miscellaneous spends to monthly total
      miscellaneousSpends.forEach(spend => {
          if (spend.timestamp && typeof spend.timestamp.toDate === 'function') {
              const spendDate = spend.timestamp.toDate();
              if (spendDate.getMonth() === currentMonth && spendDate.getFullYear() === currentYear) {
                  totalSpentThisMonth += spend.amount;
              }
          }
      });

      // Calculate total savings for the current month
      savingsData.forEach(save => {
          if (save.timestamp && typeof save.timestamp.toDate === 'function') {
              const saveDate = save.timestamp.toDate();
              if (saveDate.getMonth() === currentMonth && saveDate.getFullYear() === currentYear) {
                  totalSavingsThisMonth += save.amount;
              }
          }
      });


      monthlyTotal.textContent = `‚Çπ${totalSpentThisMonth.toFixed(2)}`; // Now includes daily and misc spends
      daysWithSpendCount.textContent = daysWithSpendSet.size;
      
      // Corrected Average Daily calculation: Divide by the number of days passed in the current month (including today)
      const numberOfDaysInMonthSoFar = today.getDate(); // Gives the day number (e.g., 1 for 1st, 15 for 15th)
      if (numberOfDaysInMonthSoFar > 0) {
        // This average is still only for spends, not savings
        monthlyAverage.textContent = `‚Çπ${(totalSpentThisMonth / numberOfDaysInMonthSoFar).toFixed(2)}`; 
      } else {
        monthlyAverage.textContent = '‚Çπ0.00'; 
      }


      // Miscellaneous Spends
      let totalMisc = 0;
      miscellaneousSpendList.innerHTML = ''; // Clear previous list
      if (miscellaneousSpends.length === 0) {
        miscellaneousSpendList.innerHTML = `<li>No miscellaneous spends yet.</li>`;
        miscTotal.innerText = `‚Çπ0.00`;
      } else {
        // Sort miscellaneous spends by timestamp (newest first)
        miscellaneousSpends.sort((a, b) => {
            const timeA = a.timestamp && typeof a.timestamp.toDate === 'function' ? a.timestamp.toDate().getTime() : 0;
            const timeB = b.timestamp && typeof b.timestamp.toDate === 'function' ? b.timestamp.toDate().getTime() : 0;
            return timeB - timeA;
        });

        miscellaneousSpends.forEach(spend => {
          totalMisc += spend.amount;
          const li = document.createElement('li');
          li.className = "misc-item";
          // Format date for display from timestamp
          const displayDate = spend.timestamp && typeof spend.timestamp.toDate === 'function' 
                              ? spend.timestamp.toDate().toLocaleDateString('en-GB') 
                              : (new Date(spend.date + 'T00:00:00')).toLocaleDateString('en-GB'); // Fallback to date string if timestamp is missing or invalid
          li.innerHTML = `<span>${spend.title}</span>: ‚Çπ${spend.amount.toFixed(2)} <br><small>Date: ${displayDate}</small>`;
          miscellaneousSpendList.appendChild(li);
        });
        miscTotal.innerText = `‚Çπ${totalMisc.toFixed(2)}`;
      }

      // Savings Overview
      monthlySavingDisplay.textContent = `‚Çπ${totalSavingsThisMonth.toFixed(2)}`;
      const distinctSavingsGoals = new Set();
      savingsData.forEach(save => {
          if (save.goal) {
              distinctSavingsGoals.add(save.goal);
          }
      });
      totalSavingsGoalsDisplay.textContent = `${distinctSavingsGoals.size} Goals`;


      // --- Prepare data for Pie Chart (Today's Spending Breakdown) ---
      const categoryBreakdownToday = {};
      todaysSpends.forEach(spend => {
        categoryBreakdownToday[spend.category] = (categoryBreakdownToday[spend.category] || 0) + spend.amount;
      });

      // Also add today's miscellaneous spends to the pie chart
      miscellaneousSpends.filter(spend => {
        if (spend.timestamp && typeof spend.timestamp.toDate === 'function') {
            const spendDate = spend.timestamp.toDate();
            spendDate.setHours(0,0,0,0);
            return spendDate.getTime() === today.getTime();
        }
        return false;
      }).forEach(miscSpend => {
          const category = miscSpend.category || 'Miscellaneous'; // Use 'Miscellaneous' as category if not specified
          categoryBreakdownToday[category] = (categoryBreakdownToday[category] || 0) + miscSpend.amount;
      });

      createPieChart(categoryBreakdownToday);

    } catch (error) {
      console.error("Error loading spending statistics:", error);
      alert("Error loading statistics: " + error.message);
      dailySummaryDisplay.textContent = 'Error loading data';
      dailyLimitDisplay.textContent = 'Daily Limit: Error';
      dailyRemaining.textContent = 'Remaining: Error';
      monthlyTotal.textContent = 'Error';
      monthlyAverage.textContent = 'Error';
      daysWithSpendCount.textContent = 'Error';
      miscTotal.textContent = 'Error';
      miscellaneousSpendList.innerHTML = '<li>Error loading miscellaneous spends.</li>';
      monthlySavingDisplay.textContent = 'Error'; // Clear new savings display
      totalSavingsGoalsDisplay.textContent = 'Error'; // Clear new savings display
    }
  }

  // --- Chart.js Initialization ---
  function createPieChart(data) {
    const ctx = document.getElementById('expense-chart').getContext('2d');

    // Destroy existing chart if it exists to prevent duplicates
    if (expenseChart) {
      expenseChart.destroy();
    }

    expenseChart = new Chart(ctx, {
      type: 'pie',
      data: {
        labels: Object.keys(data),
        datasets: [{
          label: 'Expenses',
          data: Object.values(data),
          backgroundColor: [
            '#ff6b6b', '#4ecdc4', '#1a535c', '#ffe66d', '#ff9f1c', '#6a0572', '#00b894', '#FF6384', '#36A2EB', '#FFCE56'
          ],
          borderColor: '#ffffff',
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: '#333',
              font: {
                size: 14
              }
            }
          },
          title: {
            display: true,
            text: 'Today\'s Spending by Category',
            font: {
              size: 16,
              weight: 'bold'
            },
            color: '#333'
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                let label = context.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed !== null) {
                  label += '‚Çπ' + context.parsed.toFixed(2);
                }
                return label;
              }
            }
          }
        }
      }
    });
  }

</script>

</body>
</html>